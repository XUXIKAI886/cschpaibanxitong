# 动态调休对接逻辑 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 将调休对接从固定映射改为“按当天排班动态均分”，只在“上班”单元格显示对接休息人员列表，并在无休息人员时提示。

**Architecture:** 在 `排班表系统.html` 中新增“按天分配”算法：基于 DOM 中上班/休息状态统计当日人员，按随机轮询进行分配；将对接信息写回上班单元格的辅助区域。移除固定对接映射与其渲染逻辑，同时更新规则卡片文案。

**Tech Stack:** HTML5 / CSS3 / JavaScript(ES6)。

---

### Task 1: 更新规则卡片文案与移除固定映射

**Files:**
- Modify: `排班表系统.html`（`<style>` 与 `<body>` 顶部卡片，`<script>` 中固定映射）

**Step 1: 写一个失败的断言（手动）**

打开页面控制台执行：
```js
console.assert(typeof renderHandoverRules === 'undefined', '固定规则渲染应被移除');
```
预期：断言失败（当前函数存在）。

**Step 2: 最小实现**

- 删除 `handoverMap` / `getHandoverText` / `renderHandoverRules`。
- 顶部规则卡片改为静态说明项，例如：
  - 对接信息显示在上班单元格
  - 按当天排班随机均分分配
  - 每个上班人员必须对应一个休息人员（休息可重复）
  - 无休息人员显示“对接：无休息人员”
- 移除 `DOMContentLoaded` 中对 `renderHandoverRules()` 的调用。

**Step 3: 重新执行断言（手动）**

```js
console.assert(typeof renderHandoverRules === 'undefined', '固定规则渲染应被移除');
```
预期：无错误输出。

**Step 4: 提交**

```bash
git add 排班表系统.html
git commit -m "更新调休对接规则说明并移除固定映射"
```

---

### Task 2: 新增动态分配算法与上班单元格展示

**Files:**
- Modify: `排班表系统.html`（`<style>`、`setScheduleStatus`、新增分配函数）

**Step 1: 写一个失败的断言（手动）**

控制台执行：
```js
console.assert(typeof updateHandoverAssignments === 'function', '动态对接更新函数应存在');
```
预期：断言失败（函数不存在）。

**Step 2: 最小实现**

新增工具函数：
```js
function shuffleArray(list) { /* Fisher-Yates */ }
function updateHandoverAssignments() { /* 按天分配并写回上班单元格 */ }
```

修改 `setScheduleStatus`：
- 上班：结构包含 `schedule-status` + `handover-text`，加 `handover-assigned` 类。
- 休息：仅显示“休息”，不包含对接信息。
- 每次状态变更后调用 `updateHandoverAssignments()`。

分配规则：
- 按天统计上班/休息人员。
- 若无休息人员：所有上班单元格显示“对接：无休息人员”。
- 若休息人数 ≥ 上班人数：随机顺序将**所有**休息人员轮询分配到上班人员（上班可能接到多个休息）。
- 若休息人数 < 上班人数：休息人员可重复分配，确保**每个上班人员**都有对接对象。

CSS 新增：
```css
.schedule-cell.handover-assigned { flex-direction: column; gap: 0.25rem; }
.handover-text { font-size: 0.75rem; font-weight: 500; color: rgba(255,255,255,0.85); text-align: center; }
```

**Step 3: 重新执行断言（手动）**

```js
console.assert(typeof updateHandoverAssignments === 'function', '动态对接更新函数应存在');
```
预期：无错误输出。

**Step 4: 手动验证**

- 周六 4 上班 / 2 休息 ⇒ 每个上班都有“对接：某休息”，休息可重复。
- 周日 2 上班 / 4 休息 ⇒ 两个上班分别显示 2 个休息（均分）。
- 无休息 ⇒ 上班显示“对接：无休息人员”。
- 休息单元格不显示对接信息。

**Step 5: 提交**

```bash
git add 排班表系统.html
git commit -m "实现动态调休对接分配并展示"
```
